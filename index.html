<!-- <!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>ReadQuest: A Reading Adventure</title> -->


   <!-- <!-- Tailwind -->
   <!-- <script src="https://cdn.tailwindcss.com"></script> -->


   <!-- Google Fonts -->
   <!-- <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Comic+Neue:wght@700&display=swap" rel="stylesheet">

<!--  --> -->
   <!-- Custom CSS -->
   <!-- <link rel="stylesheet" href="styles.css"> -->


   <!-- Main App Logic -->
   <!-- <script defer src="script.js"></script> -->
<!-- </head>


<body class="bg-amber-50 text-gray-800">


   <div class="container mx-auto p-4 max-w-4xl">
       <header class="flex justify-between items-center mb-6 p-4 bg-white rounded-lg shadow-md">
           <h1 class="app-title text-3xl font-bold text-sky-600">ReadQuest</h1>
           <div id="lives-container" class="flex items-center space-x-2">
               <span class="text-2xl" title="Lives">❤️</span>
               <span id="lives-counter" class="text-2xl font-bold text-rose-500">0</span>
           </div>
       </header>


       <main id="app-container"> -->


           <!-- Page: Home -->
           <!-- <section id="page-home" class="page active">
               <div class="text-center bg-white p-10 rounded-lg shadow-xl">
                   <h2 class="text-4xl font-bold mb-6">What will you do today?</h2>
                   <p class="text-lg text-gray-600 mb-8">Let's start an adventure!</p>


                   <button id="btn-goto-library"
                       class="w-full max-w-xs bg-sky-500 hover:bg-sky-600 text-white text-2xl font-bold py-4 px-8 rounded-lg shadow-lg transition duration-300 transform hover:scale-105">
                       Read a Book
                   </button>
               </div>
           </section> -->


           <!-- Page: Library -->
           <!-- <section id="page-library" class="page">
               <div class="text-center w-full">
                   <h2 class="text-4xl font-bold mb-8">Choose Your Story</h2>


                   <div id="library-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>


                   <button id="btn-library-back"
                       class="mt-8 bg-gray-400 hover:bg-gray-500 text-white text-lg font-bold py-2 px-6 rounded-lg shadow-md transition duration-300">
                       Back
                   </button>
               </div>
           </section>


           <!-- Page: Reader -->
           <!-- <section id="page-reader" class="page">
               <div class="w-full bg-white p-6 md:p-10 rounded-lg shadow-xl text-center">


                   <h2 id="reader-title" class="text-3xl font-bold mb-6"></h2>


                   <div id="reader-content"
                       class="text-2xl md:text-4xl leading-relaxed my-10 p-6 bg-gray-50 rounded-md min-h-[150px]"></div>


                   <div id="reader-line-display"
                       class="text-2xl md:text-4xl leading-relaxed my-10 p-6 bg-gray-50 rounded-md min-h-[150px]"></div>


                   <div class="flex flex-col md:flex-row gap-4 justify-center">
                       <button id="btn-read-correctly"
                           class="bg-green-500 hover:bg-green-600 text-white text-xl font-bold py-3 px-6 rounded-lg shadow-md transition duration-300">
                           I read it! (Next)
                       </button>


                       <button id="btn-simulate-miscue"
                           class="bg-yellow-500 hover:bg-yellow-600 text-white text-xl font-bold py-3 px-6 rounded-lg shadow-md transition duration-300">
                           Simulate Mistake (Gemini)
                       </button>
                   </div>


               </div>
           </section> --> -->


           <!-- Page: Quiz -->
           <!-- <section id="page-quiz" class="page">
               <div class="w-full bg-white p-10 rounded-lg shadow-xl text-center">
                   <h2 class="text-3xl font-bold mb-4">Comprehension Check!</h2>


                   <p id="quiz-question" class="text-2xl text-gray-700 mb-8 min-h-[60px]"></p>
                   <div id="quiz-options" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6"></div>
                   <p id="quiz-feedback" class="text-xl font-semibold min-h-[30px]"></p>
               </div>
           </section>


           <!-- Page: Game -->
           <!-- <section id="page-game" class="page">
               <div class="text-center w-full">
                   <h2 class="text-3xl font-bold mb-4">Play Time!</h2>
                   <p class="text-lg text-gray-600 mb-4">Use A (left), D (right), and W (jump).</p>


                   <canvas id="game-canvas" width="800" height="500"></canvas>


                   <button id="btn-quit-game"
                       class="mt-4 bg-red-500 hover:bg-red-600 text-white text-lg font-bold py-2 px-6 rounded-lg shadow-md transition duration-300">
                       Quit Game
                   </button>
               </div>
           </section>


           <!-- Modal: Miscue Feedback -->
           <!-- <div id="feedback-modal"
               class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4"
               style="display: none;">


               <div class="bg-rose-100 p-8 rounded-lg shadow-2xl max-w-md w-full text-center">
                   <h3 class="text-2xl font-bold text-rose-800 mb-4">Let's try that word!</h3> -->

<!-- 
                   <div id="feedback-content" class="text-xl text-rose-700 mb-6"></div>


                   <button id="btn-modal-continue"
                       class="bg-sky-500 hover:bg-sky-600 text-white text-xl font-bold py-3 px-8 rounded-lg shadow-md transition duration-300">
                       Got it! (Next)
                   </button>
               </div>


           </div>


       </main>
   </div>


</body>
</html> --> 
// --- Global Variables provided by the Canvas Environment ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// --- Firebase CDN Imports ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- Gemini API Call Setup ---
const API_KEY = ""; // Canvas will inject the key at runtime
const MODEL_TTS = "gemini-2.5-flash-preview-tts";
const API_URL_TTS = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_TTS}:generateContent?key=${API_KEY}`;

// --- DOM Elements ---
const headerTitle = document.getElementById('header-title');
const backButton = document.getElementById('back-button');
const viewContainer = document.getElementById('view-container');
const ttsControls = document.getElementById('tts-controls');
const ttsButton = document.getElementById('tts-button');
const ttsButtonText = document.getElementById('tts-button-text');
const messageBox = document.getElementById('message-box');
const loadingSpinner = document.getElementById('loading-spinner');

// --- State Variables ---
let db;
let auth;
let currentView = 'library'; 
let selectedBookFile = null;
let currentBookTitle = '';
let currentBookContent = []; // Array of sentences
let currentAudio = null;
let isPlaying = false;
let currentSentenceIndex = 0;
let maxRetries = 3;

// Map of available books 
const availableBooks = {
    "book 1.pdf": { title: "Why Is It So Hot Today?", theme: "Animals & Weather", color: 'bg-yellow-400' },
    "book 2.pdf": { title: "Saving the Moon", theme: "Adventure & Friendship", color: 'bg-blue-400' },
    "book3.pdf": { title: "Dive!", theme: "Ocean & Science", color: 'bg-green-400' },
    "book 4.pdf": { title: "My Dream City", theme: "Community & Planning", color: 'bg-pink-400' }
};

// ----------------------------------------------------------------------
// --- Utility Functions (WAV Conversion) ---
// ----------------------------------------------------------------------

function writeString(view, offset, string) {
    for (let i = 0; i < string.length; i++) {
        view.setUint8(offset + i, string.charCodeAt(i));
    }
}

function base64ToArrayBuffer(base64) {
    const binaryString = atob(base64);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
}

/** Converts raw 16-bit PCM audio data into a standard WAV file format Blob. */
function pcmToWav(pcm16, sampleRate = 24000) {
    const buffer = new ArrayBuffer(44 + pcm16.length * 2);
    const view = new DataView(buffer);

    // RIFF chunk descriptor
    writeString(view, 0, 'RIFF');
    view.setUint32(4, 36 + pcm16.length * 2, true);
    writeString(view, 8, 'WAVE');
    
    // FMT sub-chunk
    writeString(view, 12, 'fmt ');
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true); 
    view.setUint16(22, 1, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * 2, true);
    view.setUint16(32, 2, true);
    view.setUint16(34, 16, true);
    
    // DATA sub-chunk
    writeString(view, 36, 'data');
    view.setUint32(40, pcm16.length * 2, true);

    // Write the PCM data
    for (let i = 0; i < pcm16.length; i++) {
        view.setInt16(44 + i * 2, pcm16[i], true);
    }

    return new Blob([buffer], { type: 'audio/wav' });
}

// ----------------------------------------------------------------------
// --- UI Feedback Functions ---
// ----------------------------------------------------------------------

function showMessage(message, isError = true) {
    messageBox.textContent = message;
    messageBox.className = isError 
        ? "mt-4 p-3 bg-red-200 text-red-800 rounded-xl" 
        : "mt-4 p-3 bg-secondary/30 text-primary rounded-xl font-medium";
    messageBox.classList.remove('hidden');
}

function hideMessage() {
    messageBox.classList.add('hidden');
}

function setLoading(isLoading) {
    if (isLoading) {
        loadingSpinner.classList.remove('hidden');
        ttsButton.disabled = true;
    } else {
        loadingSpinner.classList.add('hidden');
        // Only enable TTS button in reader view if content is loaded
        if (currentBookContent.length > 0 && currentView === 'reader') {
            ttsButton.disabled = false;
        }
    }
}

// ----------------------------------------------------------------------
// --- View Rendering ---
// ----------------------------------------------------------------------

function renderLibraryView() {
    headerTitle.textContent = 'Welcome to the Story Hub!';
    backButton.classList.add('hidden');
    ttsControls.classList.add('hidden');
    
    let html = `
        <div class="p-4">
            <h2 class="text-3xl font-display text-primary mb-6 text-center tracking-wide">Choose Your Adventure!</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 p-4">
    `;
    
    Object.keys(availableBooks).forEach(file => {
        const book = availableBooks[file];
        const bgClass = book.color;

        // Use window.handleBookSelection for click handler
        html += `
            <div class="book-card p-2 rounded-2xl border-4 border-black ${bgClass} shadow-xl transform hover:scale-[1.05] active:scale-100" 
                 onclick="window.handleBookSelection('${file}')">
                <div class="w-full aspect-[3/4] rounded-lg shadow-inner flex flex-col items-center justify-center p-4 bg-white/70">
                    <span class="text-4xl font-extrabold font-display text-primary leading-none text-center">${book.title.split(' ').map(w => w[0]).join('')}</span>
                    <p class="text-xs mt-2 text-gray-700 font-semibold uppercase">${book.theme}</p>
                </div>
                <h3 class="text-lg font-bold text-gray-800 leading-tight mt-3 mb-1 text-center">${book.title}</h3>
                <p class="text-sm text-gray-600 font-medium text-center">${book.theme}</p>
            </div>
        `;
    });

    html += `
            </div>
        </div>
    `;
    viewContainer.innerHTML = html;
}

function renderReaderView() {
    headerTitle.textContent = currentBookTitle || 'Story Time';
    backButton.classList.remove('hidden');
    ttsControls.classList.remove('hidden');
    
    viewContainer.innerHTML = `
        <div id="reader-content" class="p-4 bg-white rounded-lg shadow-inner">
            ${currentBookContent.length === 0 
                ? '<p class="text-center text-primary italic mt-10 font-bold">Just a moment! Loading the text...</p>'
                : currentBookContent.map((sentence, index) => 
                    `<p id="sentence-${index}" class="py-1 mb-1">${sentence}</p>`
                ).join('')
            }
        </div>
    `;
    
    // Set button to initial "Start Reading" state
    ttsButtonText.textContent = "Start Reading";
    ttsButton.classList.remove('bg-red-500', 'hover:bg-red-600');
    ttsButton.classList.add('bg-accent-green', 'hover:bg-green-600', 'animate-pulse-light');
    ttsButton.disabled = currentBookContent.length === 0;
}

/** Handles view switching and triggers rendering. */
function navigate(newView) {
    if (newView === 'library') {
        stopReading(false); 
        hideMessage();
    }
    currentView = newView;
    updateView();
}
window.navigate = navigate; // EXPOSE globally for index.html button

function updateView() {
    viewContainer.scrollTop = 0; // Scroll to top on view switch
    if (currentView === 'library') {
        renderLibraryView();
    } else {
        renderReaderView();
    }
}


// ----------------------------------------------------------------------
// --- Book Loading and TTS Logic ---
// ----------------------------------------------------------------------

async function handleBookSelection(fileName) {
    navigate('reader');
    selectedBookFile = fileName;
    currentBookTitle = availableBooks[fileName].title;
    currentSentenceIndex = 0;
    currentBookContent = [];

    // Show loading state immediately
    renderReaderView(); 
    hideMessage();
    setLoading(true);

    currentBookContent = await fetchBookContent(selectedBookFile);
    
    if (currentBookContent.length > 0) {
        renderReaderView(); // Final render with content
        showMessage(`Story: ${currentBookTitle} is ready! Tap 'Start Reading' below.`, false);
    } else {
        renderReaderView();
        showMessage("I couldn't find the story content. Please go back and try another book.", true);
    }
    setLoading(false);
}
window.handleBookSelection = handleBookSelection; // EXPOSE globally for book cards

async function fetchBookContent(fileName) {
    const contentFetchId = `uploaded:${fileName}`;
    try {
        const response = await fetch('/api/file_contents', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contentFetchId: contentFetchId })
        });
        const data = await response.json();
        
        let fullText = data.content;
        // Clean up file markers
        fullText = fullText.replace(/\[Image \d+\]/g, ' ');
        fullText = fullText.replace(/--- PAGE \d+ ---/g, ' ');
        fullText = fullText.replace(/<br\s*\/>/g, ' ');
        fullText = fullText.replace(/(\r\n|\n|\r)/gm, ' ');
        fullText = fullText.replace(/\s+/g, ' ').trim();
        
        // Split into sentences
        const sentences = fullText.match(/[^.!?]+[.!?]|\n/g) || [];
        
        return sentences
            .map(s => s.trim())
            .filter(s => s.length > 1);

    } catch (error) {
        console.error("Error fetching book content:", error);
        showMessage(`Loading Error: ${error.message}`, true);
        return [];
    }
}

/** Recursive function to fetch and play audio for one sentence at a time. */
async function fetchAndPlaySentence(index, retryCount = 0) {
    if (!isPlaying || index >= currentBookContent.length) {
        stopReading(true);
        return;
    }
    
    const sentence = currentBookContent[index];
    const activeSentenceElement = document.getElementById(`sentence-${index}`);

    if (activeSentenceElement) {
        // Highlight the currently reading sentence
        document.querySelectorAll('#reader-content .reading-highlight').forEach(el => el.classList.remove('reading-highlight'));
        activeSentenceElement.classList.add('reading-highlight');
        activeSentenceElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    const payload = {
        contents: [{ parts: [{ text: sentence }] }],
        generationConfig: {
            responseModalities: ["AUDIO"],
            speechConfig: {
                voiceConfig: { prebuiltVoiceConfig: { voiceName: "Achird" } } // Friendly voice
            }
        },
    };

    try {
        const response = await fetch(API_URL_TTS, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        const part = result?.candidates?.[0]?.content?.parts?.[0];
        const audioData = part?.inlineData?.data;
        const mimeType = part?.inlineData?.mimeType; 
        
        if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
            const sampleRateMatch = mimeType.match(/rate=(\d+)/);
            const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 24000;
            
            const pcmData = base64ToArrayBuffer(audioData);
            const pcm16 = new Int16Array(pcmData);
            const wavBlob = pcmToWav(pcm16, sampleRate);
            
            // Clean up old audio before creating new one
            if (currentAudio) {
                currentAudio.pause();
                URL.revokeObjectURL(currentAudio.src); 
            }
            
            currentAudio = new Audio(URL.createObjectURL(wavBlob));
            currentAudio.play();
            
            currentAudio.onended = () => {
                currentSentenceIndex++;
                fetchAndPlaySentence(currentSentenceIndex); // Play next sentence
            };

            currentAudio.onerror = (e) => {
                console.error("Audio playback error, skipping sentence:", e);
                currentSentenceIndex++;
                fetchAndPlaySentence(currentSentenceIndex);
            };

        } else {
            throw new Error("Invalid TTS response or missing audio data.");
        }

    } catch (error) {
        console.error(`TTS API Error for sentence ${index}:`, error);
        if (retryCount < maxRetries) {
            // Exponential backoff
            const delay = Math.pow(2, retryCount) * 1000;
            await new Promise(resolve => setTimeout(resolve, delay));
            fetchAndPlaySentence(index, retryCount + 1);
        } else {
            showMessage(`Speech generation failed after multiple tries. Skipping sentence.`, true);
            currentSentenceIndex++;
            fetchAndPlaySentence(currentSentenceIndex); 
        }
    }
}

/** Toggles between starting and stopping the reading process. */
function toggleReading() {
    if (isPlaying) {
        stopReading();
    } else {
        startReading();
    }
}

function startReading() {
    if (currentBookContent.length === 0) {
        showMessage("The story is empty. Try selecting another book.", true);
        return;
    }
    
    isPlaying = true;
    ttsButtonText.textContent = "Stop Reading";
    ttsButton.classList.remove('bg-accent-green', 'animate-pulse-light', 'hover:bg-green-600');
    ttsButton.classList.add('bg-red-500', 'hover:bg-red-600');
    hideMessage();
    
    fetchAndPlaySentence(currentSentenceIndex);
}

function stopReading(isEndOfBook = false) {
    isPlaying = false;
    
    // Clean up audio
    if (currentAudio) {
        currentAudio.pause();
        URL.revokeObjectURL(currentAudio.src);
        currentAudio = null;
    }
    
    // Remove all sentence highlights
    document.querySelectorAll('#reader-content .reading-highlight').forEach(el => el.classList.remove('reading-highlight'));

    if (isEndOfBook) {
        ttsButtonText.textContent = "Read Again";
        currentSentenceIndex = 0;
        showMessage("Great job! You finished the story!", false);
    } else {
        ttsButtonText.textContent = "Resume Reading";
        showMessage("Reading is paused. Tap 'Resume Reading' to continue.", false);
    }

    ttsButton.classList.remove('bg-red-500', 'hover:bg-red-600');
    ttsButton.classList.add('bg-accent-green', 'hover:bg-green-600', 'animate-pulse-light');
}


// ----------------------------------------------------------------------
// --- Initialization ---
// ----------------------------------------------------------------------

async function firebaseInit() {
    setLogLevel('debug');
    if (!firebaseConfig) return;
    
    const app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    auth = getAuth(app);

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // User authenticated or anonymous user created
        }
    });
    
    try {
         if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
         } else {
            await signInAnonymously(auth);
         }
    } catch (e) {
        console.error("Initial auth attempt failed.", e);
    }
}

// Attach event listeners
ttsButton.addEventListener('click', toggleReading);

// Start the application after the DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    firebaseInit();
    updateView(); // Start on the Library View
});
